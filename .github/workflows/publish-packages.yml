name: Publish Packages

on:
  workflow_dispatch: {}
  push:
    branches:
      - master

permissions:
  id-token: write
  contents: read

jobs:
  publish-packages:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      NODE_OPTIONS: '--max_old_space_size=8192'
    steps:
      - uses: actions/checkout@v2
      - name: Setup
        uses: ./.github/actions/setup
        with:
          extra_filters: '-F @botpress/* -F llmz'

      - name: update npm
        shell: bash
        run: npm install -g npm@^11.5.1 # Required for OIDC login

      - name: Publish Client
        uses: botpress/gh-actions/publish-if-not-exists@master
        with:
          path: './packages/client'
      - name: Publish SDK
        uses: botpress/gh-actions/publish-if-not-exists@master
        with:
          path: './packages/sdk'
      - name: Publish CLI
        uses: botpress/gh-actions/publish-if-not-exists@master
        with:
          path: './packages/cli'
      - name: Publish Chat Client
        uses: botpress/gh-actions/publish-if-not-exists@master
        with:
          path: './packages/chat-client'
      - name: Publish Cognitive Client
        uses: botpress/gh-actions/publish-if-not-exists@master
        with:
          path: './packages/cognitive'
      - name: Publish Vai
        uses: botpress/gh-actions/publish-if-not-exists@master
        with:
          path: './packages/vai'
      - name: Publish Zai
        uses: botpress/gh-actions/publish-if-not-exists@master
        with:
          path: './packages/zai'
      - name: Publish LLMz
        uses: botpress/gh-actions/publish-if-not-exists@master
        with:
          path: './packages/llmz'

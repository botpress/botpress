export default "# LLMz Project Structure\n\n## Overview\n\nLLMz is a code-first TypeScript AI agent framework that generates and executes TypeScript code in a sandboxed VM rather than using traditional JSON tool calling. This document outlines the project structure and key components.\n\n**Package Name**: `llmz`\n**Version**: 0.0.27\n**Description**: An LLM-native TypeScript VM built on top of Zui\n**Repository**: https://github.com/botpress/botpress\n\n## Core Philosophy\n\nStop chaining tools. Start generating real code.\n\nLLMz leverages the massive body of TypeScript knowledge in LLMs to enable agents that can handle complex logic, loops, conditionals, and multi-tool orchestration in a single call—eliminating the multiple expensive roundtrips required by traditional JSON tool calling.\n\n## Project Structure\n\n```\npackages/llmz/\n├── src/                        # Source code\n│   ├── llmz.ts                # Core execution engine\n│   ├── vm.ts                  # Virtual machine with isolated-vm\n│   ├── compiler/              # TypeScript compilation pipeline\n│   │   ├── compiler.ts        # Main compiler logic\n│   │   └── plugins/           # AST transformation plugins\n│   │       ├── track-tool-calls.ts      # Instrument tool calls\n│   │       ├── variable-extraction.ts   # Extract variable usage\n│   │       ├── line-tracking.ts         # Source map generation\n│   │       ├── jsx-preserve-newlines.ts # Maintain JSX formatting\n│   │       ├── async-iterator.ts        # Async iteration support\n│   │       ├── braces-tsx.ts            # TSX braces handling\n│   │       ├── replace-comment.ts       # Comment processing\n│   │       └── return-async.ts          # Async return handling\n│   ├── prompts/               # Dual-mode prompt system\n│   │   ├── prompt.ts          # Prompt generation logic\n│   │   ├── common.ts          # Shared prompt utilities\n│   │   ├── dual-modes.ts      # Mode selection logic\n│   │   ├── chat-mode/         # Chat mode prompts\n│   │   │   ├── system.md.ts   # System prompt\n│   │   │   └── user.md.ts     # User prompt\n│   │   └── worker-mode/       # Worker mode prompts\n│   │       ├── system.md.ts   # System prompt\n│   │       └── user.md.ts     # User prompt\n│   ├── chat.ts                # Chat interface & message handling\n│   ├── tool.ts                # Tool definition & execution\n│   ├── exit.ts                # Exit system for agent termination\n│   ├── component.ts           # UI component system\n│   ├── component.default.ts   # Default component implementations\n│   ├── jsx.ts                 # JSX runtime support\n│   ├── objects.ts             # Namespaced tools & variables\n│   ├── context.ts             # Execution context & iteration tracking\n│   ├── transcript.ts          # Conversation history management\n│   ├── result.ts              # Execution result types\n│   ├── snapshots.ts           # Pausable/resumable execution\n│   ├── errors.ts              # Error handling & signals\n│   ├── stack-traces.ts        # Stack trace sanitization\n│   ├── truncator.ts           # Content truncation for token limits\n│   ├── citations.ts           # Citation management\n│   ├── inspect.ts             # Variable inspection utilities\n│   ├── hoist.ts               # Variable hoisting logic\n│   ├── handlers.ts            # Event handlers\n│   ├── abort-signal.ts        # Abort signal implementation\n│   ├── formatting.ts          # Code formatting utilities\n│   ├── getter.ts              # Value getter utilities\n│   ├── types.ts               # Core type definitions\n│   ├── typings.ts             # TypeScript type generation\n│   ├── utils.ts               # Utility functions\n│   ├── index.ts               # Public API exports\n│   └── __tests__/             # Test utilities\n├── examples/                   # Example implementations\n│   ├── 01_chat_basic/         # Basic chat mode\n│   ├── 02_chat_exits/         # Custom exits\n│   ├── 03_chat_conditional_tool/  # Conditional tool usage\n│   ├── 04_chat_small_models/  # Small model optimization\n│   ├── 05_chat_web_search/    # Web search integration\n│   ├── 06_chat_confirm_tool/  # Tool confirmation\n│   ├── 07_chat_guardrails/    # Guardrails & safety\n│   ├── 08_chat_multi_agent/   # Multi-agent systems\n│   ├── 09_chat_variables/     # Variable management\n│   ├── 10_chat_components/    # UI components\n│   ├── 11_worker_minimal/     # Minimal worker mode\n│   ├── 12_worker_fs/          # File system access\n│   ├── 13_worker_sandbox/     # Sandbox execution\n│   ├── 14_worker_snapshot/    # Snapshot/resume\n│   ├── 15_worker_stacktraces/ # Stack trace handling\n│   ├── 16_worker_tool_chaining/  # Tool chaining\n│   ├── 17_worker_error_recovery/ # Error recovery\n│   ├── 18_worker_security/    # Security features\n│   ├── 19_worker_wrap_tool/   # Tool wrapping\n│   ├── 20_chat_rag/           # RAG implementation\n│   ├── start.ts               # Example runner\n│   └── utils/                 # Example utilities\n├── docs/                       # Documentation\n├── scripts/                    # Build scripts\n│   └── compile-markdown.mts   # Markdown to TypeScript compiler\n├── dist/                       # Compiled output\n├── package.json               # Package configuration\n├── tsconfig.json              # TypeScript configuration\n├── tsup.config.ts             # Build configuration (ESM + CJS)\n├── vitest.config.ts           # Test configuration\n├── vitest.setup.ts            # Test setup\n├── vitest.snapshot.ts         # Snapshot utilities\n├── vitest.stack-trace-serializer.ts  # Stack trace serialization\n├── eslint.config.mjs          # ESLint configuration\n├── README.md                  # User-facing documentation\n├── DOCS.md                    # Detailed documentation\n└── CLAUDE.md                  # Claude Code guidance\n```\n\n## Key Components\n\n### 1. Core Execution Engine (`llmz.ts`)\n\nThe main execution loop that orchestrates:\n- Tool calling and result processing\n- Thinking about outputs and context\n- Error recovery and retry logic\n- Variable state persistence across iterations\n\nRuns until one of these conditions:\n1. An Exit is returned (agent completes)\n2. Agent waits for user input (Chat Mode)\n3. Maximum iterations reached (safety limit)\n\n### 2. Virtual Machine (`vm.ts`)\n\nSandboxed code execution environment:\n- **Production**: Uses `isolated-vm` for security isolation\n- **CI/Development**: Falls back to Node.js VM for compatibility\n- **Browser**: Standard JavaScript execution\n\n### 3. Compiler Pipeline (`compiler/`)\n\nBabel-based TypeScript compilation with AST transformations:\n1. Parse TypeScript/JSX into Abstract Syntax Tree\n2. Apply custom plugins for instrumentation and tracking\n3. Generate executable JavaScript with source maps\n4. Track tool calls, variables, and line numbers\n\n### 4. Prompt System (`prompts/`)\n\nDual-mode prompt generation:\n- **Chat Mode** (`chat-mode/`): Interactive conversational agents\n- **Worker Mode** (`worker-mode/`): Automated execution environments\n- Markdown templates compiled to TypeScript\n- Dynamic content injection at runtime\n\n### 5. Tool System (`tool.ts`)\n\nType-safe functions with Zod/Zui schemas:\n- Input/output validation with TypeScript inference\n- Synchronous and asynchronous support\n- Retry logic and error handling\n- Tool aliases for multiple names\n\n### 6. Exit System (`exit.ts`)\n\nStructured agent termination:\n- Built-in exits: `ThinkExit`, `ListenExit`, `DefaultExit`\n- Custom exits with typed schemas\n- Type-safe result checking with `result.is(exit)`\n- Agent usage: `return { action: 'exit_name', ...data }`\n\n### 7. Component System (`component.ts`, `jsx.ts`)\n\nReact-like UI components for interactive chat:\n- JSX compilation and rendering\n- Multi-line text support\n- Nested/composed components\n- Maps to communication channels (Webchat, SMS, etc.)\n\n### 8. Objects (`objects.ts`)\n\nNamespaced containers for related functionality:\n- Group tools and variables together\n- Readonly and writable variable support\n- Type validation with schemas\n- Mutation tracking across iterations\n\n### 9. Context & Iteration (`context.ts`)\n\nExecution context management:\n- Iteration tracking and status\n- Variable state preservation\n- Built-in exits (Think, Listen, Default)\n- Execution mode detection\n\n### 10. Chat Interface (`chat.ts`)\n\nChat mode functionality:\n- Message handling and history\n- User interaction management\n- Component yielding\n- Transcript management\n\n### 11. Results (`result.ts`)\n\nType-safe execution results:\n- Success/Error/Interrupted states\n- Type-safe exit checking\n- Error handling and recovery\n- Partial result support\n\n### 12. Snapshots (`snapshots.ts`)\n\nPausable/resumable execution:\n- Throw `SnapshotSignal` to halt execution\n- Serialize complete execution state\n- Resume from exact same point\n- Useful for long-running workflows\n\n### 13. Advanced Features\n\n**Thinking** (`context.ts`, `errors.ts`):\n- Agent-initiated: `return { action: 'think' }`\n- Tool-initiated: Throw `ThinkSignal`\n- Forces reflection and variable inspection\n\n**Hooks** (defined in `llmz.ts`):\n- `onTrace`: Non-blocking monitoring/logging\n- `onExit`: Exit validation and guardrails\n- `onBeforeExecution`: Code mutation and security\n- `onIterationEnd`: State augmentation between iterations\n- `onBeforeTool`: Modify tool inputs before execution\n- `onAfterTool`: Modify tool outputs after execution\n\n**Stack Traces** (`stack-traces.ts`):\n- Sanitization of internal framework details\n- User-friendly error messages\n- Source map support\n\n**Truncation** (`truncator.ts`):\n- Automatic token limit handling\n- Content wrapping and unwrapping\n- Preserves structure while reducing size\n\n## Execution Modes\n\n### Chat Mode\nEnabled when `chat` is provided to `execute()`:\n- Interactive conversational agents\n- Agents can yield React components\n- Special `ListenExit` for user interaction\n- Transcript management for conversation history\n\n### Worker Mode\nEnabled when `chat` is omitted from `execute()`:\n- Automated execution environments\n- Focus on computation and data processing\n- Uses `DefaultExit` if no custom exits provided\n- Sandboxed execution with security isolation\n\n## Dependencies\n\n### Core Runtime\n- `isolated-vm`: Secure JavaScript execution environment\n- `@babel/*`: TypeScript/JSX compilation pipeline\n- `@botpress/client`: Botpress API integration\n- `@bpinternal/zui`: Schema validation and TypeScript generation\n- `@botpress/cognitive`: LLM generation\n- `@bpinternal/thicktoken`: Token counting\n\n### Utilities\n- `handlebars`: Template processing for prompts\n- `lru-cache`: Caching for compiled code\n- `lodash-es`: Utility functions\n- `prettier`: Code formatting\n- `exponential-backoff`: Retry logic\n- `ulid`: ID generation\n- `bytes`, `ms`: Formatting utilities\n\n### Development\n- `tsup`: Fast TypeScript bundler (ESM + CJS)\n- `vitest`: Modern test framework\n- `@microsoft/api-extractor`: API documentation\n- `ts-node`, `tsx`: TypeScript execution\n- `esbuild`: Fast bundler\n\n## Build & Test Commands\n\n```bash\n# Build the package\npnpm build\n\n# Type checking\npnpm check:type\n\n# Development mode\npnpm watch\n\n# Run tests\npnpm test\npnpm test:watch\npnpm test:update\n\n# Generate prompts\npnpm generate\n```\n\n## Testing Configuration\n\n- Vitest with custom LLM testing configuration\n- Retry mechanism (2 retries) for LLM non-determinism\n- Extended timeout (60s) for LLM responses\n- Custom snapshot serializers for stack traces\n- Markdown and text file loaders\n\n## Environment Variables\n\n- `VM_DRIVER`: Choose VM execution environment ('isolated-vm' | 'node')\n- `CI`: Automatically detected, affects VM driver selection\n\n## Generated Code Structure\n\nEvery LLMz code block follows this pattern:\n\n```typescript\n// Comments help LLM think and plan\nconst result = await toolCall({ param: 'value' })\n\n// Complex logic impossible with JSON tool calling\nif (result > threshold) {\n  // Do something\n} else {\n  // Do something else\n}\n\n// Required: Return statement to exit\nreturn { action: 'done', result: finalValue }\n// OR for chat mode:\nreturn { action: 'listen' }\n```\n\n## Security Considerations\n\n- VM isolation prevents host system access\n- Stack trace cleaning removes internal details\n- Tool access control with granular permissions\n- Content truncation for token limits\n- Error recovery with graceful handling\n\n## Battle-Tested at Scale\n\n- 1+ year in production\n- Millions of active users\n- Hundreds of thousands of deployed agents\n- Powers Botpress platform globally\n\n## Export Structure\n\nMain exports from `index.ts`:\n- `execute()`: Main execution function\n- `init()`: Optional preload for performance\n- `Tool`, `Exit`, `ObjectInstance`: Core building blocks\n- `Component` system: UI components\n- `Chat`: Chat interface\n- `Snapshot`: Pausable execution\n- Signal types: `SnapshotSignal`, `ThinkSignal`, `LoopExceededError`\n- Result types: `ExecutionResult`, `SuccessExecutionResult`, `ErrorExecutionResult`\n- Context types: `Context`, `Iteration`, `ListenExit`, `ThinkExit`, `DefaultExit`\n- Utilities: `utils.toValidObjectName`, `utils.toValidFunctionName`, `utils.wrapContent`, `utils.truncateWrappedContent`\n\n## Architecture Patterns\n\n### Execution Flow\n1. **Prompt Generation**: Select and generate appropriate prompt based on mode\n2. **Code Generation**: LLM generates TypeScript code with embedded tools\n3. **Compilation**: Babel transforms code with custom plugins\n4. **Execution**: Run in isolated VM or Node.js with monitoring\n5. **Result Processing**: Type-safe result handling and error recovery\n\n### Key Design Principles\n- **Type Safety**: Full TypeScript inference throughout\n- **Sandboxing**: Secure execution in isolated environment\n- **Observability**: Comprehensive tracing and monitoring\n- **Extensibility**: Hooks for customization at every stage\n- **Performance**: Code splitting, caching, lazy loading\n- **Reliability**: Error recovery, retry logic, graceful degradation\n"